======================================================================
以Postfix為例詳解郵件伺服器
======================================================================

:slug: mail-server-architecture
:lang: zht
:date: 2016-06-10 15:04
:tags: postfix, server, mail

.. contents::

郵件系統中的單元往往會有相互重複的功能，對於初學者的我來說，肯定是需要好好整理歸納的。本文會以傳統的郵件收發模式為模型，結合Postfix這個郵件伺服器實現來說明其結構原理。會穿插一些DNS的相關知識，正解和反解對於郵件伺服器是比較重要的，對於如何處理垃圾郵件、病毒也有會說明。希望整理出一個適用的小型郵件伺服器例項（Webmail+密碼認證方式管理的客戶端）——搭起來+垃圾/廣告/病毒過濾+賬戶安全性+隱私。

郵件組成
--------------------------------------------------

* 符合RFC5322的郵件頭和郵件主體，就郵件頭而言：
  1. 針對收信端有：*To* 直接收信者、 *Cc* 抄送者、 *Bcc* 暗送者等；
  2. 針對傳送端有：*From* 最原始發信者、 *Sender* 其他發信者、 *Reply-To* 設定回信地址非原始地址等。

* 符合 `MIME <https://en.wikipedia.org/wiki/MIME>`_ 規範的非文字附件

明確幾個定義
--------------------------------------------------

**MUA（Mail User Agent）**：一個用於收發並管理郵件的使用者客戶端，僅僅在使用者執行它的時候才會運作，一般執行在個人電腦（本地）上，
當發信時，MUA會去主動連線MSA或者MTA以處理使用者的發信請求，MSA和MTA都採用了smtp協議，但是又有少許不同，比如MSA使用的是587埠而MTA使用的是25號埠。現在的驗證模式基本不會由郵件伺服器來直接管理允許發信者的IP地址，因為在公網IP資源不夠用總是動態分配的情況下，這是不合理的。所以驗證的工作會要求MUA提供使用者名稱和密碼在伺服器端校驗。當然也有一個非標準的SSL加密smtp協議，走的是465埠，但是相容性很差，不予考慮。
當收信時，信件由MTA預先保留到mailbox下（一般是以mbox格式儲存在使用者家目錄下），當MDA檢測到MUA可以通訊的時候便將信件傳送到客戶端。客戶端下載信件有兩種獨立的方法：一個是POP（Post Office Protocol），這種方法每當郵件從伺服器下下載下來之後，伺服器上不再保留郵件，只能下載一次，意味著不能多終端檢視郵件，且無法對郵件標記為已檢視、已回覆或者已轉發；另一種方法是IMAP（Internet Message Access Protocl），這個可以保留郵件到伺服器上，那麼上述的弊端就不見了。

**MSA（Mail Submission Agent）**：一個使用者接收從MUA提交的電子郵件，並協助MTA做郵件傳遞工作的程式。目前很多的MTA已經包含了MSA的功能,*MSA處理髮信的請求，MTA處理收信的請求*,這句話我査了很久，還是沒有明白它們兩個到底是如何分工的，MSA是否可以不依賴於MTA而單獨工作，根據目前查到的資訊來看，MSA僅僅是分立出來以獲取以下幾點好處，本身還是需要依賴MTA傳遞郵件的：

* 因為MSA直接與MUA互動，所以可以修正郵件的一些格式上的錯誤，比如日期、郵件ID、收件人資訊等。並且或許可以馬上給寫信人也就是客戶端報告錯誤而不需要等到MTA已經把郵件傳送完畢後才發現錯誤再向寫信人報告，我認為這個是非常有用的。
* 很多ISP和機構網路環境為了抑制垃圾郵件而限制了連線遠端MTA上25埠的功能，MSA因為可以使用587埠，從而使得網路使用的靈活性大大提升。
* MSA和MTA的分工工作方式可以讓MTA拒絕郵件轉發變得更加簡單，只需要將收件人非指向本地服務域名的郵件當作垃圾處理即可。與此同時，MSA就需要接受發往網際網路上任何收件地址的資訊，好在可以設定僅接受已經驗證過的發信客戶端。
* 還有就是MSA和MTA可以設定不同的策略用於遮蔽垃圾郵件。大多數的MSA需要完整的使用者名稱和密碼驗證，通過這樣子的機制就可以很輕易地發現發信者是誰，這樣子如果有人傳送了垃圾郵件，肯定是要為其負責的。因為在隨機域名間建立信賴關係基本上是不可能的，也無法像上述通過使用者和密碼來驗證不同域名間的使用者關係（不然這個世界只要一個使用者名稱就可以走天下了），所以被設定為收信的MTA就需要建立一個完整的垃圾郵件遮蔽機制（往往依賴本地的一些規則或者第三方的鑑定機構），為了區別垃圾郵件和合法郵件，同時也需要一個排錯機制，畢竟系統有時候可能也會因為本地規則不完善或者第三方機構誤收錄而出錯。這一點真的很重要，MSA和MTA分立後可以通過使用者名稱密碼驗證基本忽略郵件提交程式的垃圾郵件檢測。

**MTA（Mail Tansfer Agent）**：這個可以說是整個郵件系統的核心了，DNS下的MX記錄也是指的提供MTA服務的主機。MTA可以從另一個MTA、一個MSA或者直接從MUA下獲取郵件，通過SMTP協議傳輸郵件。當信件的收件人郵箱並非本機管理的時候，這個郵件就會被轉發到另一個MTA（黑函可能就是這樣子出現的），每轉發一次，就會在郵件頭資訊新增一個跟蹤記錄（Received——伺服器地址，越後新增的越靠前）。如何選擇下一跳的MTA伺服器是由SMTP協議描述的，不過MTA伺服器本身也可以指定自定義路由。當MTA確定了接收到的郵件就是由自己處理的時候，就會把郵件傳遞給MDA做分發，並記錄Return-Path（使用者@伺服器地址）到郵件頭。
Postfix下針對MTA的設定非常多，在構建結構圖前，我會先把常用的設定整理一遍。

**MDA（Mail Delivery Agent）**：在網際網路郵件體系中，MTA是通過它來將郵件分發給各個使用者，一般是儲存在使用者伺服器端的mailbox中。

**MRA（Mail Retrieval Agent）**：這個其實是一個技術上的定義說明，並不指代特殊的一個元件，詳細的可以看下述的說明圖。

Postfix下常見的設定
--------------------------------------------------

關於Postfix的結構可以看看 `這裡 <http://www.postfix.org/OVERVIEW.html>`_ ，看了這個結構說明就可以發現：Postfix可以實現MSA、MTA、MRA、MDA的功能，可以說一個Postfix就搞定了，關於Postfix main.cf下的配置有幾百種，這邊僅僅列舉重要的，也是學習的一個手段。
配置檔案main.cf內常用的引數設定方式有4種：

1. 單一值
2. 通過逗號、“\”或者空格起行的來分隔設定值
3. 直接將引數放在檔案裡面後指向指定檔案
4. 通過type:table這樣子的模式來設定值，詳細的看 `Postfix Lookup Table <http://www.postfix.org/DATABASE_README.html>`_ 。

**mydomain**：這個定義的就是本伺服器在網際網路中屬於哪一個域名，預設是myhostname值去掉由.分隔的第一個字元後所得的值，可以不設定。引數設定方法：1

**myhostname**：這個比較重要，建議採用FQDN格式，比如：mail.bekcpear.io。引數設定方法：1

**myorigin**：這個就是郵件發信地點了，比如在郵件頭的mail from下顯示。一般設定為myhostname即可，但是根據官方的文件來看，說如果一個域名下由多臺郵件伺服器，應該將這個值設定為域名，並做好別名資料庫，分別指向不同使用者，不是很懂，暫且忽略。

**mydestination**：定義的是可以被MDA分發到的主機，預設值是：`mydestination = $myhostname, localhost.$mydomain, localhost`。針對目的地的使用者名稱是在/etc/passwd和/etc/alias這兩個檔案下設定的，注意虛擬域名有其單獨設定的地方，不要在這邊設定；備用的MX記錄也不是設定在這邊的。引數設定方法：2/3/4

**mynetworks**：這個很重要，是設定的信任網路，這個設定下的網路地址可以很輕鬆的通過這個郵件伺服器來中轉或者傳送郵件，所以設定需要注意。設定了這個值之後，會導致mynetworks\_style的設定失效。所以關於mynetworks\_style的就不寫了。引數設定方法：2/3/4

**relay\_domains**：這個是用於判斷郵件的目的域名非本伺服器域名時是否屬於本引數內，屬於了才會對其進行轉發，否則就會將有點丟棄。所以猜想是否個人使用的郵件伺服器完全沒有必要設定MX記錄，那就可以不涉及本地郵件轉發的問題了。詳細的實際使用後更新本內容。引數設定方法：2/3/4

**smtpd\_client\_restrictions**：用於限制允許連線的客戶端，預設是空的就是所有的地址都可以連線。最基本需要設定的是兩個值：1）check\_client\_access

傳統Mail Server結構圖解(結合Postfix設定)
--------------------------------------------------

從發郵件到目的MTA收件：

::

                                  +-------MSA[smtp:587]
                                  |        |
  MUA -----------------------------+------ MTA[smtp:25] --- ... --- MTA:pull
          main.cf:smtpd_client_restrictions-|                    |-main.cf:smtpd_sender_restricitons
      main.cf:smtpd_recipient_restrictions-|
          main.cf:smtpd_replay_restrictions-|

目的MTA分發郵件：

::

                                              MECHANISMS:
                                      via_mail_transform_agent,
                                      via_mail_delivery_agent,
                            direct_delivery_to_an_mbox_formatted_mailbox,
                                direct_delivery_to_a_maildir_directory,
                                            standard_output
                                                  |
  (pull)MTA ------- MDA +++++++++++++++++++++++++ MRA ++++ MUA
                    |
        be_usually_invoked_by_MTA/MRA


（未完）
